<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: TransactionsController
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!TransactionsController.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (T)</a> &raquo;
    
    
    <span class="title">TransactionsController</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: TransactionsController
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActionController::Base</li>
          
            <li class="next"><span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></li>
          
            <li class="next">TransactionsController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/controllers/transactions_controller.rb</dd>
  
</dl>
<div class="clear"></div>








  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">- (Object) <strong>create</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="ApplicationController.html" title="ApplicationController (class)">ApplicationController</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ApplicationController.html#after_sign_in_path_for-instance_method" title="ApplicationController#after_sign_in_path_for (method)">#after_sign_in_path_for</a></span>, <span class='object_link'><a href="ApplicationController.html#after_sign_up_path_for-instance_method" title="ApplicationController#after_sign_up_path_for (method)">#after_sign_up_path_for</a></span>, <span class='object_link'><a href="ApplicationController.html#archive_notification-instance_method" title="ApplicationController#archive_notification (method)">#archive_notification</a></span>, <span class='object_link'><a href="ApplicationController.html#authenticate_role%21-instance_method" title="ApplicationController#authenticate_role! (method)">#authenticate_role!</a></span>, <span class='object_link'><a href="ApplicationController.html#authenticate_subscribed%21-instance_method" title="ApplicationController#authenticate_subscribed! (method)">#authenticate_subscribed!</a></span>, <span class='object_link'><a href="ApplicationController.html#current_daycare-instance_method" title="ApplicationController#current_daycare (method)">#current_daycare</a></span>, <span class='object_link'><a href="ApplicationController.html#set_locale-instance_method" title="ApplicationController#set_locale (method)">#set_locale</a></span>, <span class='object_link'><a href="ApplicationController.html#strategic_partnership%21-instance_method" title="ApplicationController#strategic_partnership! (method)">#strategic_partnership!</a></span></p>

  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="create-instance_method">
  
    - (<tt>Object</tt>) <strong>create</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/transactions_controller.rb', line 2</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_plan_type'>plan_type</span> <span class='op'>==</span> <span class='int'>2</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_manager?'>manager?</span>  
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_ethic_2_path'>ethic_2_path</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_dashboard_path'>dashboard_path</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>      

  <span class='ivar'>@plan</span> <span class='op'>=</span> <span class='const'>Plan</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>plan_type:</span> <span class='int'>1</span><span class='comma'>,</span> <span class='label'>language:</span> <span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_locale'>locale</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

  <span class='id identifier rubyid_current_plan_type'>current_plan_type</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_plan_type'>plan_type</span>
  <span class='ivar'>@deposit_plan</span> <span class='op'>=</span> <span class='const'>Plan</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>plan_type:</span> <span class='id identifier rubyid_current_plan_type'>current_plan_type</span><span class='comma'>,</span> <span class='label'>language:</span> <span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_locale'>locale</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>

  <span class='comment'># bill_amount = 0;
</span>  <span class='comment'># @subscription = nil
</span>  <span class='comment'># unless params[:subscription_id].blank?
</span>  <span class='comment'>#   @subscription = Subscription.find(params[:subscription_id])
</span>  <span class='comment'>#   days = 0
</span>  <span class='comment'>#   unless @subscription.payment_mode.nil?
</span>  <span class='comment'>#     case @subscription.payment_mode.unit
</span>  <span class='comment'>#     when &#39;week&#39;
</span>  <span class='comment'>#       days = 7 * @subscription.payment_mode.period
</span>  <span class='comment'>#     when &#39;month&#39;
</span>  <span class='comment'>#       days = 30 * @subscription.payment_mode.period
</span>  <span class='comment'>#     when &#39;year&#39;        
</span>  <span class='comment'>#       days = 30 * @subscription.payment_mode.period * 12
</span>  <span class='comment'>#     end
</span>  <span class='comment'>#   end
</span>
  <span class='comment'>#   full_amount = @plan.price * current_user.daycare.num_children * days
</span>  <span class='comment'>#   bill_amount = @subscription.discount_code.nil? ? full_amount : full_amount * (100-@subscription.discount_code.value) * 0.01
</span>  <span class='comment'>#   if current_user.transactions.where(deposit: false).count == 0
</span>  <span class='comment'>#     bill_amount -= current_user.total_deposit_amount
</span>  <span class='comment'>#     bill_amount = 0 if bill_amount &lt;= 0
</span>  <span class='comment'>#   end
</span>  <span class='comment'># end
</span>
  <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>=</span> <span class='ivar'>@deposit_plan</span><span class='period'>.</span><span class='id identifier rubyid_price'>price</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_plan_type'>plan_type</span> <span class='op'>&gt;=</span> <span class='int'>2</span>
    <span class='id identifier rubyid_plan_discount_code'>plan_discount_code</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_daycare'>daycare</span><span class='period'>.</span><span class='id identifier rubyid_discount_code'>discount_code</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_plan_discount_code'>plan_discount_code</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='comment'># current_user.daycare.discount_code_id = plan_discount_code.id
</span>      <span class='comment'># current_user.daycare.save
</span>      <span class='comment'># current_user.discount_code = plan_discount_code
</span>      <span class='comment'># current_user.save        
</span>      <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>=</span> <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='int'>100</span><span class='op'>-</span><span class='id identifier rubyid_plan_discount_code'>plan_discount_code</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='float'>0.01</span>
    <span class='kw'>end</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_plan_type'>plan_type</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='comment'># deposit_amount = deposit_amount * current_user.affiliate.num_member
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_manager?'>manager?</span>  
      <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>=</span> <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>*</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_daycare'>daycare</span><span class='period'>.</span><span class='id identifier rubyid_departments'>departments</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>=</span> <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>*</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_affiliate'>affiliate</span><span class='period'>.</span><span class='id identifier rubyid_num_member'>num_member</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_manager?'>manager?</span>  
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_ethic_2_path'>ethic_2_path</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_dashboard_path'>dashboard_path</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='ivar'>@transaction</span> <span class='op'>=</span> <span class='const'>Transaction</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span>   <span class='op'>=</span> <span class='id identifier rubyid_deposit_amount'>deposit_amount</span> <span class='comment'>#params[:upgrade_type] ? deposit_amount : bill_amount
</span>  <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_currency'>currency</span> <span class='op'>=</span> <span class='ivar'>@deposit_plan</span><span class='period'>.</span><span class='id identifier rubyid_currency'>currency</span> <span class='comment'>#params[:upgrade_type] ? @deposit_plan.currency : @plan.currency
</span>  <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_card_num'>card_num</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:card_number</span><span class='rbracket'>]</span>
  <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_user_id'>user_id</span>  <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>

  <span class='id identifier rubyid_user_upgraded'>user_upgraded</span> <span class='op'>=</span> <span class='kw'>false</span>

  <span class='comment'># Create a charge: this will charge the user&#39;s card
</span>  <span class='kw'>begin</span>
    <span class='id identifier rubyid_stripe_customer'>stripe_customer</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_stripe_customer'>stripe_customer</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_stripe_customer'>stripe_customer</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span>
      <span class='id identifier rubyid_stripe_customer'>stripe_customer</span> <span class='op'>=</span> <span class='const'>Stripe</span><span class='op'>::</span><span class='const'>Customer</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span>
        <span class='symbol'>:email</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span>
        <span class='symbol'>:source</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:stripe_card_token</span><span class='rbracket'>]</span><span class='comma'>,</span>
      <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_charge'>charge</span> <span class='op'>=</span> <span class='const'>Stripe</span><span class='op'>::</span><span class='const'>Charge</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span>
      <span class='symbol'>:amount</span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_amount'>amount</span> <span class='op'>*</span> <span class='int'>100</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='comment'># Amount in cents
</span>      <span class='symbol'>:currency</span> <span class='op'>=&gt;</span> <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_currency'>currency</span><span class='comma'>,</span>
      <span class='symbol'>:customer</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_stripe_customer'>stripe_customer</span><span class='comma'>,</span>
      <span class='symbol'>:description</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
    <span class='rparen'>)</span>
    
    <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_deposit_required'>deposit_required</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_charge'>charge</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='comment'># current_user.deposit_required = false
</span>      <span class='comment'># current_user.plan_type = 4
</span>      <span class='id identifier rubyid_user_upgraded'>user_upgraded</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>

    <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_charge_id'>charge_id</span> <span class='op'>=</span> <span class='id identifier rubyid_charge'>charge</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
    <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_deposit'>deposit</span> <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_deposit_required'>deposit_required</span>  <span class='comment'>#params[:upgrade_type] ? true : false
</span>    <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_plan_type'>plan_type</span> <span class='op'>=</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_plan_type'>plan_type</span>
    <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>

    <span class='kw'>unless</span> <span class='ivar'>@subscription</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='ivar'>@subscription</span><span class='period'>.</span><span class='id identifier rubyid_transaction_id'>transaction_id</span> <span class='op'>=</span> <span class='ivar'>@transaction</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span>
      <span class='ivar'>@subscription</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>        
    <span class='kw'>end</span>
    
    <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_stripe_customer'>stripe_customer</span> <span class='op'>=</span> <span class='id identifier rubyid_stripe_customer'>stripe_customer</span>
    <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_card_number'>card_number</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:card_number</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_plan_type'>plan_type</span> <span class='op'>&gt;</span> <span class='int'>1</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_user_upgraded'>user_upgraded</span>
      <span class='id identifier rubyid_send_confirmation_email'>send_confirmation_email</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_manager?'>manager?</span>  
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_ethic_2_path'>ethic_2_path</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>***************** Current User is not manager *********************</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_dashboard_path'>dashboard_path</span>
    <span class='kw'>end</span>

  <span class='kw'>rescue</span> <span class='const'>Stripe</span><span class='op'>::</span><span class='const'>CardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>**************************************</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_dashboard_path'>dashboard_path</span>
    <span class='comment'># The card has been declined
</span>  <span class='kw'>rescue</span> <span class='const'>Stripe</span><span class='op'>::</span><span class='const'>InvalidRequestError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>**************************************</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_dashboard_path'>dashboard_path</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Sun Sep  2 14:53:26 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.2.3).
</div>

  </body>
</html>